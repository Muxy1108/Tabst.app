# å¼€å‘æ–‡æ¡£å¯¼èˆª

> æ˜¾ç„¶ï¼Œè¿™ç§æ–‡æ¡£éšç€å¼€å‘çš„è¿›ç¨‹ï¼Œå¼€å‘æ–‡æ¡£å¿«é€Ÿç´¯ç§¯ï¼Œéå¸¸å®¹æ˜“è¿‡æ—¶ï¼Œçœ‹ä¸ªä¹å°±å¥½ã€‚

## ğŸ“š alphaTab ä¸»é¢˜åˆ‡æ¢çš„å®Œæ•´æŠ€æœ¯æ–‡æ¡£

è¿™ä¸ªé¡¹ç›®çš„æš—é»‘æ¨¡å¼å®ç°æ¶‰åŠ Electronã€Reactã€alphaTab Worker çº¿ç¨‹ç­‰å¤šä¸ªå±‚çº§ã€‚æˆ‘ä»¬ä¸ºæ­¤ç¼–å†™äº†**äº”ä»½äº’è¡¥çš„æ–‡æ¡£**ï¼š

### 1. ğŸ—ï¸ [ç³»ç»Ÿæ¶æ„åˆ†æ](./ALPHATAB_ARCHITECTURE.md)

**é’ˆå¯¹**ï¼šæƒ³è¦ç†è§£æ•´ä¸ªç³»ç»Ÿå¦‚ä½•è¿ä½œçš„å¼€å‘è€…

**åŒ…å«å†…å®¹**ï¼š

- ç³»ç»Ÿæ¶æ„æ¦‚è§ˆï¼ˆJS ä¾§ã€Worker ä¾§ã€é€šä¿¡æœºåˆ¶ï¼‰
- ä¸¤ç§é¢œè‰²æ›´æ–°æ–¹æ¡ˆçš„å®Œæ•´å¯¹æ¯”
  - âŒ æ–¹æ¡ˆ Aï¼šç®€å•ä¿®æ”¹ + render()ï¼ˆä¸ºä»€ä¹ˆä¸å·¥ä½œï¼‰
  - âœ… æ–¹æ¡ˆ Bï¼šå®Œå…¨é‡å»ºï¼ˆä¸ºä»€ä¹ˆå·¥ä½œï¼‰
- ä¸»é¢˜åˆ‡æ¢çš„æ—¶åºå›¾ï¼ˆä» 0ms åˆ° 100ms çš„å®Œæ•´è¿‡ç¨‹ï¼‰
- å…³é”®è®¾è®¡å†³ç­–è§£æ
- æ•°æ®æµè¿½è¸ªï¼ˆCSS å˜é‡ â†’ JS â†’ Workerï¼‰
- æ½œåœ¨æ”¹è¿›æ–¹å‘

**æœ€ä½³é˜…è¯»åœºæ™¯**ï¼š

- ç¬¬ä¸€æ¬¡æ·±å…¥äº†è§£é¡¹ç›®çš„åŒå­¦
- éœ€è¦ç†è§£ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§æ¶æ„
- æƒ³è¦æ”¹è¿›ç°æœ‰å®ç°

---

### 2. ğŸ“‹ [é‡å»ºå’Œåˆ·æ–°æœºåˆ¶](./REBUILD_REFRESH_MECHANISMS.md)

**é’ˆå¯¹**ï¼šéœ€è¦ç»´æŠ¤å’Œä¿®æ”¹ alphaTab é›†æˆä»£ç çš„å¼€å‘è€…

**åŒ…å«å†…å®¹**ï¼š

- 5 ä¸ªå±‚çº§çš„é‡å»º/åˆ·æ–°æœºåˆ¶è¯¦è§£
  1. `api.render()` - è½»é‡çº§åˆ·æ–°
  2. `api.renderTracks()` - éƒ¨åˆ†éŸ³è½¨é‡æ–°æ¸²æŸ“
  3. `api.tex()` - é‡æ–°åŠ è½½ä¹è°±å†…å®¹
  4. å®Œå…¨é‡å»º - API é”€æ¯å’Œé‡æ–°åˆ›å»º
  5. æ’­æ”¾çŠ¶æ€ä¿ç•™ï¼ˆé«˜çº§åœºæ™¯ï¼‰
- æ¯ä¸ªæœºåˆ¶çš„å·¥ä½œåŸç†ã€ä½•æ—¶ä½¿ç”¨ã€ä»£ä»·å¯¹æ¯”
- å®Œæ•´çš„ä»£ç æ¡†æ¶å’Œå®ç°ç»†èŠ‚
- å¼‚æ­¥å¤„ç†çš„è€ƒè™‘ï¼ˆä¸ºä»€ä¹ˆç”¨ `void (async () => {})()`ï¼‰
- æ•…éšœæ’æŸ¥æŒ‡å—
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æœ€ä½³é˜…è¯»åœºæ™¯**ï¼š

- éœ€è¦ä¿®æ”¹ç°æœ‰çš„ä¸»é¢˜åˆ‡æ¢é€»è¾‘
- é‡åˆ°é¢œè‰²ä¸æ›´æ–°çš„é—®é¢˜
- æƒ³è¦ä¼˜åŒ–é‡å»ºæ€§èƒ½
- éœ€è¦æ·»åŠ æ’­æ”¾çŠ¶æ€ä¿ç•™åŠŸèƒ½

---

### 3. âš¡ [ä¸»é¢˜åˆ‡æ¢é€ŸæŸ¥è¡¨](./THEME_SWITCH_QUICK_REFERENCE.md)

**é’ˆå¯¹**ï¼šéœ€è¦å¿«é€ŸæŸ¥æ‰¾ç­”æ¡ˆæˆ–åº”æ€¥ä¿®å¤çš„å¼€å‘è€…

**åŒ…å«å†…å®¹**ï¼š

- æ ¸å¿ƒé—®é¢˜ä¸€å¥è¯æ€»ç»“
- å¿«é€Ÿå¯¹æ¯”è¡¨ï¼ˆä¸åŒåœºæ™¯ vs è°ƒç”¨æ–¹æ³•ï¼‰
- å®ç°ä»£ç æ¡†æ¶ï¼ˆå¤åˆ¶å³ç”¨ï¼‰
- å…³é”®ç»†èŠ‚çš„ç®€æ˜è¯´æ˜
- æ•…éšœæ’æŸ¥å¿«é€Ÿæ¸…å•
- æ–‡ä»¶å¯¼èˆª
- æ€§èƒ½å»ºè®®é€ŸæŸ¥

**æœ€ä½³é˜…è¯»åœºæ™¯**ï¼š

- éœ€è¦å¿«é€Ÿæ‰¾åˆ°æŸä¸ªç‰¹å®šé—®é¢˜çš„ç­”æ¡ˆ
- éœ€è¦ä»£ç æ¡†æ¶å‚è€ƒ
- åœ¨çº¿ä¸Šé—®é¢˜æ—¶éœ€è¦å¿«é€Ÿäº†è§£æ¦‚å†µ
- æƒ³è¦å¿«é€Ÿå›é¡¾å…³é”®ç‚¹

---

### 4. ğŸ”´ [åˆå§‹åŒ–æµç¨‹é—®é¢˜åˆ†æ](./INITIALIZATION_FLOW_PROBLEM.md)

**é’ˆå¯¹**ï¼šé‡åˆ°ä¸»é¢˜åˆ‡æ¢æ—¶ tracks å‚æ•°ä¸¢å¤±é—®é¢˜çš„å¼€å‘è€…

**åŒ…å«å†…å®¹**ï¼š

- é—®é¢˜çš„è¯¦ç»†å¤ç°ï¼šåˆæ¬¡åŠ è½½ vs ä¸»é¢˜åˆ‡æ¢æ—¶çš„æµç¨‹å¯¹æ¯”
- 5 ä¸ªæ—¶åºå›¾ï¼Œå±•ç¤ºå‚æ•°ä¸¢å¤±çš„å‘ç”Ÿä½ç½®
- æ ¹æœ¬åŸå› åˆ†æï¼šä¸ºä»€ä¹ˆé¦–æ¬¡åŠ è½½æ—¶æ­£å¸¸ï¼Œä¸»é¢˜åˆ‡æ¢æ—¶å‚æ•°ä¸¢å¤±
- ä»£ç ä¸­çš„ 12 ä¸ªå…³é”®é—®é¢˜ä½ç½®ï¼ˆå¸¦è¡Œå·ï¼‰
- 3 ä¸ªè§£å†³æ–¹å‘çš„ç®€è¿°
- å®Œæ•´çš„æ•…éšœæ’æŸ¥æ¸…å•

**æœ€ä½³é˜…è¯»åœºæ™¯**ï¼š

- è°ƒè¯• tracks å‚æ•°ä¸¢å¤±é—®é¢˜
- ç†è§£åˆå§‹åŒ–æµç¨‹ä¸­ settings å’Œ tracks çš„ç›¸äº’ä½œç”¨
- äº†è§£ content props å˜åŒ–å’Œä¸»é¢˜åˆ‡æ¢çš„æ—¶åºå…³ç³»

---

### 5. ğŸ”§ [tracks å‚æ•°ä¸¢å¤±çš„ä¿®å¤æ–¹æ¡ˆ](./TRACKS_PARAMETER_FIX.md)

**é’ˆå¯¹**ï¼šéœ€è¦å®æ–½ä¿®å¤çš„å¼€å‘è€…

**åŒ…å«å†…å®¹**ï¼š

- **æ–¹æ¡ˆ A**ï¼šä½¿ç”¨ Ref ä¿å­˜ tracks é…ç½®ï¼ˆæ¨è â­â­â­â­ï¼‰
  - æ”¹è¿› 1-5ï¼šå…·ä½“çš„ä»£ç ä¿®æ”¹æ­¥éª¤
  - æœ€å°åŒ–æ”¹åŠ¨ï¼Œæœ€å¤§åŒ–å¯é æ€§
- **æ–¹æ¡ˆ B**ï¼šåˆ›å»ºé«˜é˜¶åˆå§‹åŒ–å‡½æ•°ï¼ˆæœ€å®Œæ•´ â­â­â­â­â­ï¼‰
  - å®Œæ•´çš„ `initializeAlphaTabInstance()` å‡½æ•°
  - ç»Ÿä¸€é¦–æ¬¡åˆå§‹åŒ–å’Œä¸»é¢˜é‡å»º
  - ç¤ºä¾‹ä»£ç å¯ç›´æ¥ä½¿ç”¨
- **æ–¹æ¡ˆ C**ï¼šå¼•å…¥åˆå§‹åŒ–çŠ¶æ€ç®¡ç†
  - é€šè¿‡ state è¿½è¸ªåˆå§‹åŒ–è¿›åº¦
- æ–¹æ¡ˆå¯¹æ¯”è¡¨ + éªŒè¯æ¸…å•

**æœ€ä½³é˜…è¯»åœºæ™¯**ï¼š

- é€‰æ‹©ä¿®å¤æ–¹æ¡ˆ
- å¤åˆ¶ç°æˆçš„ä»£ç ç‰‡æ®µ
- æŒ‡å¯¼ä¿®å¤å®æ–½

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

```
ä½ çš„æƒ…å†µæ˜¯...                                    æ¨èé˜…è¯»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æˆ‘æ˜¯æ–°å¼€å‘è€…ï¼Œæƒ³ç†è§£æ•´ä¸ªç³»ç»Ÿ                   â†’ ALPHATAB_ARCHITECTURE.md
æˆ‘éœ€è¦ä¿®æ”¹ä¸»é¢˜åˆ‡æ¢é€»è¾‘                         â†’ REBUILD_REFRESH_MECHANISMS.md
æˆ‘éœ€è¦å¿«é€Ÿæ‰¾åˆ°ç­”æ¡ˆ                             â†’ THEME_SWITCH_QUICK_REFERENCE.md
æˆ‘é‡åˆ°äº† tracks å‚æ•°ä¸¢å¤±é—®é¢˜                   â†’ INITIALIZATION_FLOW_PROBLEM.md
æˆ‘æƒ³ä¿®å¤ tracks å‚æ•°ä¸¢å¤±é—®é¢˜                   â†’ TRACKS_PARAMETER_FIX.md
æˆ‘é‡åˆ°äº† useEffect ä¾èµ–é¡¹å›å½’é—®é¢˜              â†’ USEEFFECT_DEPENDENCY_REGRESSION.md
æˆ‘æƒ³å…¨é¢å­¦ä¹ è¿™ä¸ªå®ç°                           â†’ æŒ‰é¡ºåºè¯»æ‰€æœ‰æ–‡æ¡£
```

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µå¿«é€Ÿå›é¡¾

### é—®é¢˜

alphaTab çš„ Web Worker åœ¨åˆå§‹åŒ–æ—¶ç¼“å­˜é¢œè‰²é…ç½®ã€‚ç®€å•çš„é¢œè‰²ä¿®æ”¹ + `render()` æ— æ³•æ›´æ–° Worker çš„ç¼“å­˜ã€‚

### è§£å†³æ–¹æ¡ˆ

å®Œå…¨é‡å»ºï¼šé”€æ¯æ—§ API â†’ åˆ›å»ºæ–° APIï¼ˆæ–°é¢œè‰²ï¼‰â†’ é‡æ–°åŠ è½½ä¹è°±

### å…³é”®ä»£ç 

```typescript
// ä¸»é¢˜åˆ‡æ¢å›è°ƒ
setupThemeObserver(() => {
  void (async () => {
    // ä¿å­˜å½“å‰ä¹è°±å†…å®¹
    const currentContent = content;

    // é”€æ¯æ—§ API
    apiRef.current?.destroy();

    // è·å–æ–°é¢œè‰²
    const newColors = getAlphaTabColorsForTheme();

    // åˆ›å»ºæ–° APIï¼ˆåŒ…å«æ–°é¢œè‰²ï¼‰
    apiRef.current = new alphaTab.AlphaTabApi(el, {
      // ... settings with new colors ...
    });

    // é‡æ–°åŠ è½½ä¹è°±ï¼ˆç”¨æ–°é¢œè‰²æ¸²æŸ“ï¼‰
    await loadSoundFontFromUrl(apiRef.current, urls.soundFontUrl);
    apiRef.current.tex(currentContent);
  })();
});
```

---

## ğŸ“„ ç›¸å…³ä»£ç æ–‡ä»¶

| æ–‡ä»¶                                        | ä½œç”¨                                     | æ¨èæŸ¥çœ‹æ—¶æœº           |
| ------------------------------------------- | ---------------------------------------- | ---------------------- |
| `src/renderer/components/Preview.tsx`       | ä¸»è¦é›†æˆç‚¹ï¼ŒåŒ…å« setupThemeObserver å›è°ƒ | ä¿®æ”¹ä¸»é¢˜åˆ‡æ¢é€»è¾‘æ—¶     |
| `src/renderer/lib/themeManager.ts`          | é¢œè‰²ç®¡ç†å’Œ MutationObserver è®¾ç½®         | ç†è§£é¢œè‰²å¦‚ä½•è·å–å’Œç›‘å¬ |
| `src/renderer/lib/resourceLoaderService.ts` | Worker URL å’Œèµ„æºè·¯å¾„è·å–                | ç†è§£èµ„æºåŠ è½½æœºåˆ¶       |
| `src/renderer/lib/assets.ts`                | å­—ä½“å’ŒéŸ³é¢‘åŠ è½½                           | ç†è§£èµ„æºåŠ è½½ç»†èŠ‚       |
| `src/renderer/index.css`                    | CSS å˜é‡å®šä¹‰ï¼ˆäº®â†’æš—ä¸»é¢˜ï¼‰                | ä¿®æ”¹é¢œè‰²å€¼æ—¶           |

---

## ğŸš€ å¸¸è§ä»»åŠ¡

### ä»»åŠ¡ 1ï¼šä¿®æ”¹æš—è‰²ä¸»é¢˜çš„é¢œè‰²

1. ç¼–è¾‘ `src/renderer/index.css` ä¸­çš„ `.dark` åŒºå—
2. ä¿®æ”¹ `--alphatab-*` CSS å˜é‡å€¼
3. ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œæ”¹å˜ä¼šè‡ªåŠ¨è¢« `getAlphaTabColorsForTheme()` è¯»å–

### ä»»åŠ¡ 2ï¼šæ·»åŠ ç¬¬ä¸‰ç§ä¸»é¢˜ï¼ˆæ¯”å¦‚é«˜å¯¹æ¯”åº¦ï¼‰

1. åœ¨ `src/renderer/index.css` ä¸­æ·»åŠ æ–°çš„ classï¼ˆå¦‚ `.high-contrast`ï¼‰
2. ä¿®æ”¹ `src/renderer/lib/themeManager.ts` ä¸­çš„ `getAlphaTabColorsForTheme()` å‡½æ•°
3. æ·»åŠ æ–°çš„ä¸»é¢˜æ£€æµ‹é€»è¾‘

### ä»»åŠ¡ 3ï¼šä¼˜åŒ–ä¸»é¢˜åˆ‡æ¢æ€§èƒ½

1. æŸ¥çœ‹ [é‡å»ºå’Œåˆ·æ–°æœºåˆ¶] æ–‡æ¡£ä¸­çš„"æ€§èƒ½ä¼˜åŒ–å»ºè®®"
2. è€ƒè™‘æ·»åŠ é˜²æŠ–æˆ–èŠ‚æµ
3. å¯èƒ½éœ€è¦ä¿ç•™æ’­æ”¾çŠ¶æ€ä»¥æ”¹è¿›ç”¨æˆ·ä½“éªŒ

### ä»»åŠ¡ 4ï¼šè°ƒè¯•é¢œè‰²ä¸æ›´æ–°é—®é¢˜

1. æŸ¥çœ‹ [ä¸»é¢˜åˆ‡æ¢é€ŸæŸ¥è¡¨] ä¸­çš„"æ•…éšœæ’æŸ¥"éƒ¨åˆ†
2. æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `destroy()`
3. éªŒè¯æ–°çš„ `settings` å¯¹è±¡ä¸­æ˜¯å¦åŒ…å«æ–°é¢œè‰²
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

---

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

### ä¸ºä»€ä¹ˆ render() ä¸å·¥ä½œï¼Ÿ

Worker çº¿ç¨‹æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ã€‚åˆå§‹åŒ–æ—¶è¯»å–çš„é¢œè‰²è¢«ç¼“å­˜åˆ° Worker å†…éƒ¨ã€‚JavaScript ä¾§ä¿®æ”¹é¢œè‰²åï¼ŒWorker çœ‹ä¸åˆ°è¿™ä¸ªæ”¹å˜ã€‚

### ä¸ºä»€ä¹ˆå®Œå…¨é‡å»ºå·¥ä½œï¼Ÿ

é”€æ¯æ—§ Worker â†’ åˆ›å»ºæ–° Worker â†’ æ–° Worker åˆå§‹åŒ–æ—¶ç”¨æ–°é¢œè‰²ã€‚è¿™æ ·å¼ºåˆ¶ Worker é‡æ–°è¯»å–é¢œè‰²é…ç½®ã€‚

### ä¸ºä»€ä¹ˆç”¨ MutationObserverï¼Ÿ

Tailwind CSS é€šè¿‡æ·»åŠ /ç§»é™¤ `.dark` class æ¥å®ç°ä¸»é¢˜åˆ‡æ¢ã€‚MutationObserver å¯ä»¥è‡ªåŠ¨æ£€æµ‹ä»»ä½• class å˜åŒ–ï¼Œä¸éœ€è¦æ‰‹åŠ¨åè°ƒã€‚

### ä¸ºä»€ä¹ˆç”¨ CSS å˜é‡ï¼Ÿ

- å•ä¸€æºçœŸå€¼ï¼šCSS å’Œ JS ä½¿ç”¨åŒä¸€ä¸ªé¢œè‰²å®šä¹‰
- æ˜“äºç»´æŠ¤ï¼šä¿®æ”¹é¢œè‰²åªéœ€æ”¹ä¸€ä¸ªåœ°æ–¹
- ä¸è®¾è®¡ç³»ç»Ÿä¸€è‡´ï¼šTailwind çš„æ ‡å‡†åšæ³•

---

## ğŸ”— å¤–éƒ¨å‚è€ƒ

- [alphaTab å®˜æ–¹æ–‡æ¡£](https://www.alphatab.net/)
- [Web Workers æ¦‚å¿µ](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)
- [MutationObserver API](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [Tailwind CSS æš—æ¨¡å¼](https://tailwindcss.com/docs/dark-mode)

---

## ğŸ“ ç‰ˆæœ¬ä¿¡æ¯

- **æ›´æ–°æ—¥æœŸ**ï¼š2025 å¹´ 12 æœˆ
- **é¡¹ç›®**ï¼šTabst (minimal åˆ†æ”¯)
- **alphaTab ç‰ˆæœ¬**ï¼š@coderline/alphatab
- **å…³é”®ç‰¹æ€§**ï¼šæš—é»‘æ¨¡å¼ã€Worker çº¿ç¨‹ç®¡ç†ã€åŠ¨æ€é¢œè‰²é…ç½®

---

## â“ æœ‰é—®é¢˜ï¼Ÿ

1. **å¿«é€ŸæŸ¥æ‰¾**ï¼šä½¿ç”¨ [ä¸»é¢˜åˆ‡æ¢é€ŸæŸ¥è¡¨](./THEME_SWITCH_QUICK_REFERENCE.md)
2. **æ·±å…¥ç†è§£**ï¼šæŸ¥çœ‹ [ç³»ç»Ÿæ¶æ„åˆ†æ](./ALPHATAB_ARCHITECTURE.md)
3. **å®ç°ç»†èŠ‚**ï¼šå‚è€ƒ [é‡å»ºå’Œåˆ·æ–°æœºåˆ¶](./REBUILD_REFRESH_MECHANISMS.md)
4. **ä»£ç å‚è€ƒ**ï¼šæŸ¥çœ‹ `src/renderer/components/Preview.tsx`

---

**ç¥ä½ å¼€å‘æ„‰å¿«ï¼** ğŸ‰
