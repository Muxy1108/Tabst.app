# ğŸ“ Selection Sync å®ç°æ—¥å¿—

**æ—¥æœŸ**ï¼š2026-01-16  
**åˆ†æ”¯**ï¼š`feat/selectionAPI`  
**PR**ï¼š#7 - feat/selection api: add support to selecting note/bar and highlight its alphaTex in editor

---

## ğŸ¯ ç›®æ ‡

å®ç° alphaTab ä¹è°±ä¸ CodeMirror ç¼–è¾‘å™¨ä¹‹é—´çš„**åŒå‘é€‰åŒºåŒæ­¥**ï¼š

1. **ä¹è°± â†’ ç¼–è¾‘å™¨**ï¼šåœ¨ä¹è°±ä¸Šé€‰æ‹©éŸ³ç¬¦/å°èŠ‚æ—¶ï¼Œç¼–è¾‘å™¨ä¸­å¯¹åº”çš„ AlphaTex ä»£ç é«˜äº®
2. **ç¼–è¾‘å™¨ â†’ ä¹è°±**ï¼šç‚¹å‡»ç¼–è¾‘å™¨ä»£ç æ—¶ï¼Œä¹è°±æ»šåŠ¨å¹¶é«˜äº®åˆ°å¯¹åº”ä½ç½®
3. **æ’­æ”¾è·Ÿéšé«˜äº®**ï¼šæ’­æ”¾æ—¶ï¼Œç¼–è¾‘å™¨å®æ—¶é«˜äº®å½“å‰æ’­æ”¾çš„éŸ³ç¬¦ï¼ˆç»¿è‰²ï¼‰

---

## ğŸ“ æ¶‰åŠæ–‡ä»¶

| æ–‡ä»¶                                          | èŒè´£                                                       |
| --------------------------------------------- | ---------------------------------------------------------- |
| `src/renderer/store/appStore.ts`              | æ–°å¢ `scoreSelection`, `editorCursor`, `playbackBeat` çŠ¶æ€ |
| `src/renderer/lib/alphatex-selection-sync.ts` | æ ¸å¿ƒåŒæ­¥é€»è¾‘ï¼šè§£æå™¨ã€é«˜äº®æ‰©å±•ã€ä½ç½®æ˜ å°„                   |
| `src/renderer/components/Preview.tsx`         | ç›‘å¬ alphaTab äº‹ä»¶ï¼Œæ›´æ–° store                             |
| `src/renderer/components/Editor.tsx`          | ç›‘å¬ store å˜åŒ–ï¼Œæ›´æ–° CodeMirror é«˜äº®                      |
| `src/renderer/lib/alphatex-barlines.ts`       | ä¿®å¤å¹¶å‘è£…é¥°æ›´æ–°å¯¼è‡´çš„ CodeMirror å´©æºƒ                     |

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Zustand Store                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ scoreSelection  â”‚  â”‚  editorCursor   â”‚  â”‚  playbackBeat   â”‚      â”‚
â”‚  â”‚ (ä¹è°±é€‰åŒº)      â”‚  â”‚ (ç¼–è¾‘å™¨å…‰æ ‡)    â”‚  â”‚ (æ’­æ”¾ä½ç½®)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Preview.tsx    â”‚  â”‚    Editor.tsx     â”‚  â”‚    Preview.tsx    â”‚
â”‚ playbackRange     â”‚  â”‚ cursor tracking   â”‚  â”‚ playedBeatChanged â”‚
â”‚ HighlightChanged  â”‚  â”‚ extension         â”‚  â”‚ event             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Editor è“è‰²é«˜äº®   â”‚  â”‚  Preview é«˜äº®     â”‚  â”‚  Editor ç»¿è‰²é«˜äº®   â”‚
â”‚  (é€‰åŒºåŒæ­¥)        â”‚  â”‚  (åå‘åŒæ­¥)       â”‚  â”‚  (æ’­æ”¾è·Ÿéš)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. AlphaTex è§£æå™¨ (`parseBeatPositions`)

å°† AlphaTex æºç è§£æä¸º Beat ä½ç½®æ˜ å°„ï¼š

```typescript
interface BeatCodePosition {
  barIndex: number; // å°èŠ‚ç´¢å¼• (0-based)
  beatIndex: number; // Beat åœ¨å°èŠ‚å†…çš„ç´¢å¼•
  startOffset: number; // ä»£ç èµ·å§‹ä½ç½®
  endOffset: number; // ä»£ç ç»“æŸä½ç½®
  // ... è¡Œåˆ—ä¿¡æ¯
}
```

**å…³é”®é€»è¾‘**ï¼š

- ä» `.` æ ‡è®°å¼€å§‹è§£æï¼ˆè·³è¿‡å…ƒæ•°æ®ï¼‰
- å’Œå¼¦ `(...)` ä½œä¸ºæ•´ä½“å¤„ç†
- æ—¶å€¼ä¿®é¥°ç¬¦ `:8` ç­‰ä¸è®¡å…¥ beat ç´¢å¼•

### 2. CodeMirror è£…é¥°æ‰©å±•

ä¸¤ç§é«˜äº®æ ·å¼ï¼š

- **é€‰åŒºé«˜äº®** (`cm-score-selection-highlight`)ï¼šè“è‰²/ç´«è‰²ï¼Œæ‰‹åŠ¨é€‰æ‹©è§¦å‘
- **æ’­æ”¾é«˜äº®** (`cm-playback-highlight`)ï¼šç»¿è‰²ï¼Œæ’­æ”¾æ—¶è‡ªåŠ¨è·Ÿéš

```typescript
export function createSelectionSyncExtension(): Extension[];
export function createPlaybackSyncExtension(): Extension[];
```

### 3. åå‘åŒæ­¥ (ç¼–è¾‘å™¨ â†’ ä¹è°±)

```typescript
// å…‰æ ‡ä½ç½®è¿½è¸ª
createCursorTrackingExtension((cursor) => {
  setEditorCursor(cursor); // æ›´æ–° store
});

// Preview ç›‘å¬ editorCursor å˜åŒ–
useEffect(() => {
  const beat = findBeatInScore(
    score,
    editorCursor.barIndex,
    editorCursor.beatIndex
  );
  api.highlightPlaybackRange(beat, beat);
}, [editorCursor]);
```

---

## ğŸ› Bug ä¿®å¤è®°å½•

### Bug 1: æ—¶å€¼ä¿®é¥°ç¬¦è¢«é”™è¯¯è¯†åˆ«ä¸º Beat

**ç°è±¡**ï¼š`:8 0.6 2.5` ä¸­ï¼Œ`:8` è¢«è¯†åˆ«ä¸ºç¬¬ä¸€ä¸ª beat

**åŸå› **ï¼šè§£æå™¨å°†æ‰€æœ‰ç©ºæ ¼åˆ†éš”çš„ token éƒ½å½“ä½œ beat

**ä¿®å¤**ï¼šæ·»åŠ  `isNonBeatToken()` å‡½æ•°è¯†åˆ«å¹¶è·³è¿‡æ—¶å€¼ä¿®é¥°ç¬¦

```typescript
// çº¯æ—¶å€¼ä¿®é¥°ç¬¦ï¼Œè·³è¿‡
:8, :4, :16, :4., :8{tu 3}

// åŒ…å«éŸ³ç¬¦ï¼Œä¸è·³è¿‡
:8(3.2 0.3), :83.2
```

### Bug 2: å’Œå¼¦è¢«æ‹†åˆ†ä¸ºå¤šä¸ª Beat

**ç°è±¡**ï¼š`(0.1 0.6)` è¢«æ‹†åˆ†ä¸º `(0.1` å’Œ `0.6)`

**åŸå› **ï¼šæ‹¬å·å†…çš„ç©ºæ ¼è¢«å½“ä½œåˆ†éš”ç¬¦

**ä¿®å¤**ï¼šæ·»åŠ  `inChord` çŠ¶æ€å’Œ `chordDepth` æ·±åº¦è¿½è¸ª

```typescript
if (char === "(") {
  inChord = true;
  chordDepth++;
}
// å’Œå¼¦å†…çš„ç©ºæ ¼ä¸ä½œä¸ºåˆ†éš”ç¬¦
if (inChord) continue;
```

### Bug 3: ç´§å‡‘å†™æ³•è§£æå¤±è´¥

**ç°è±¡**ï¼š`:8(3.2 0.3)` æ•´ä¸ªè¢«å¿½ç•¥ï¼ˆæ— ç©ºæ ¼åˆ†éš”æ—¶å€¼å’Œå’Œå¼¦ï¼‰

**åŸå› **ï¼š`isNonBeatToken` æ£€æµ‹åˆ° `:æ•°å­—` å¼€å¤´å°±è·³è¿‡æ•´ä¸ª token

**ä¿®å¤**ï¼šæ·»åŠ  `extractBeatContent()` å‡½æ•°åˆ†ç¦»æ—¶å€¼å‰ç¼€

```typescript
function extractBeatContent(token: string) {
  // :8(3.2 0.3) â†’ { content: "(3.2 0.3)", prefixLength: 2 }
}
```

### Bug 4: å…ƒæ•°æ®è¢«è¯†åˆ«ä¸ºéŸ³ç¬¦

**ç°è±¡**ï¼š`\tab "author"` ä¸­çš„å­—ç¬¦ä¸²è¢«è¯†åˆ«ä¸º beat

**åŸå› **ï¼šè§£æå™¨æ²¡æœ‰æ­£ç¡®è¯†åˆ« `.` ä½œä¸ºå†…å®¹èµ·å§‹æ ‡è®°

**ä¿®å¤**ï¼šä¼˜å…ˆæŸ¥æ‰¾å•ç‹¬çš„ `.` ä½œä¸ºå†…å®¹èµ·å§‹ç‚¹

```typescript
// æŸ¥æ‰¾å•ç‹¬çš„ "."ï¼ˆä¸æ˜¯å°æ•°ç‚¹ï¼‰
if (char === "." && !isPrevDigit && !isNextDigit) {
  contentStart = i + 1;
  foundDot = true;
  break;
}
```

### Bug 5: CodeMirror å¹¶å‘è£…é¥°æ›´æ–°å´©æºƒ

**ç°è±¡**ï¼šæ»šåŠ¨æ—¶å‡ºç° `Cannot destructure property 'tile' of undefined`

**åŸå› **ï¼šå¤šä¸ª StateField åŒæ—¶ dispatch effect å¯¼è‡´å†…éƒ¨çŠ¶æ€ä¸ä¸€è‡´

**ä¿®å¤**ï¼š

1. ä½¿ç”¨ `requestAnimationFrame` å»¶è¿Ÿ dispatch
2. å…¨é¢çš„ try-catch ä¿æŠ¤
3. dispatch å‰æ£€æŸ¥ view çŠ¶æ€

```typescript
function safeDispatch(view: EditorView, effect: StateEffect<...>) {
  if (!view?.dom || !document.contains(view.dom)) return;
  requestAnimationFrame(() => {
    try {
      view.dispatch({ effects: effect });
    } catch (err) {
      console.error("[SelectionSync] Failed to dispatch:", err);
    }
  });
}
```

---

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹

| è¾“å…¥                   | æœŸæœ› Bar:Beat | è¯´æ˜                       |
| ---------------------- | ------------- | -------------------------- |
| `0.6 2.5 3.2 \|`       | 0:0, 0:1, 0:2 | åŸºç¡€éŸ³ç¬¦                   |
| `:8 0.6 2.5 \|`        | 0:0, 0:1      | æ—¶å€¼ä¿®é¥°ç¬¦è¢«è·³è¿‡           |
| `(0.1 0.6) 2.5 \|`     | 0:0, 0:1      | å’Œå¼¦ä½œä¸ºæ•´ä½“               |
| `:8(3.2 0.3) 2.5 \|`   | 0:0, 0:1      | ç´§å‡‘å†™æ³•ï¼Œé«˜äº® `(3.2 0.3)` |
| `r.4 0.6 \|`           | 0:0, 0:1      | ä¼‘æ­¢ç¬¦æ˜¯æœ‰æ•ˆ beat          |
| `(3.2 4.3 4.4).4`      | 0:0           | å’Œå¼¦åç¼€æ—¶å€¼ï¼ˆAST å¤„ç†ï¼‰   |
| `(-.2 -.3 -.4)\n:8...` | 0:0, 1:0...   | è·¨è¡Œå’Œå¼¦ï¼ˆAST å¤„ç†ï¼‰       |

---

## ğŸ†• alphaTab AST è§£æå™¨ (2026-01-16)

### èƒŒæ™¯

åŸè‡ªå®šä¹‰è§£æå™¨åœ¨å¤„ç†å¤æ‚è¾¹ç•Œæƒ…å†µæ—¶å­˜åœ¨é—®é¢˜ï¼š

- `(3.2 4.3 4.4).4` - å’Œå¼¦åç´§è·Ÿæ—¶å€¼åç¼€
- è·¨è¡Œå’Œå¼¦ + æ¢è¡Œåçš„æ—¶å€¼ä¿®é¥°ç¬¦

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ alphaTab å†…ç½®çš„ `AlphaTexParser` + `AlphaTexParseMode.Full` è¿›è¡Œ AST è§£æï¼š

```typescript
import * as alphaTab from "@coderline/alphatab";

const parser = new alphaTab.importer.alphaTex.AlphaTexParser(text);
parser.mode = alphaTab.importer.alphaTex.AlphaTexParseMode.Full;
const scoreNode = parser.read();

// AST ç»“æ„ï¼š
// scoreNode.bars -> AlphaTexBarNode[]
//   bar.beats -> AlphaTexBeatNode[]
//     beat.notes / beat.rest
//     beat.start?.offset, beat.end?.offset (ç²¾ç¡®æºç ä½ç½®)
```

### ä¼˜åŠ¿

1. **ç²¾ç¡®ä½ç½®**ï¼šAST èŠ‚ç‚¹åŒ…å« `start.offset` å’Œ `end.offset`
2. **å¥å£®æ€§**ï¼šå¤ç”¨ alphaTab ç»è¿‡å¤§é‡æµ‹è¯•çš„è§£æé€»è¾‘
3. **åå¤‡æœºåˆ¶**ï¼šAST è§£æå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°è‡ªå®šä¹‰è§£æå™¨

### å®ç°ç»†èŠ‚

- `parseBeatPositionsAST()` - åŸºäº AST çš„è§£æå™¨ï¼ˆä¼˜å…ˆï¼‰
- `parseBeatPositionsLegacy()` - è‡ªå®šä¹‰è§£æå™¨ï¼ˆåå¤‡ï¼‰
- `parseBeatPositions()` - ç»Ÿä¸€å…¥å£ï¼Œè‡ªåŠ¨é€‰æ‹©ç­–ç•¥

---

## ğŸ¨ è§†è§‰æ•ˆæœ

### é«˜äº®æ ·å¼

```css
/* é€‰åŒºé«˜äº® - è“è‰² */
.cm-score-selection-highlight {
  background-color: hsl(var(--primary) / 0.25);
  box-shadow: 0 0 0 1px hsl(var(--primary) / 0.4);
}

/* æ’­æ”¾é«˜äº® - ç»¿è‰² */
.cm-playback-highlight {
  background-color: hsl(142 76% 36% / 0.3);
  box-shadow: 0 0 0 1px hsl(142 76% 36% / 0.5);
}
```

---

## ğŸ“ åç»­ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹äºå¤§å‹æ–‡ä»¶ï¼Œè€ƒè™‘å¢é‡è§£æè€Œéå…¨é‡è§£æ
2. **æ›´ç²¾ç¡®çš„ä½ç½®æ˜ å°„**ï¼šæ”¯æŒ Note çº§åˆ«ï¼ˆå½“å‰æ˜¯ Beat çº§åˆ«ï¼‰
3. **å¤šéŸ³è½¨æ”¯æŒ**ï¼šå½“å‰åªå¤„ç†ç¬¬ä¸€ä¸ªéŸ³è½¨
4. **é”™è¯¯å®¹é”™**ï¼šè§£æå¤±è´¥æ—¶çš„ä¼˜é›…é™çº§

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [alphaTab 1.8.0 Selection API](./SelectionAPI.md)
- [CodeMirror 6 Decorations](https://codemirror.net/docs/ref/#view.Decoration)
- [Zustand State Management](https://github.com/pmndrs/zustand)
